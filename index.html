<!DOCTYPE html>
<html>
    <head>
        <title>WAMS</title>
        <meta http-equiv='content-type' content='text/html; charset=utf-8'>
        <link href="styles/bootstrap-3.0.2.min.css" rel="stylesheet">
        <link href="styles/prettify.css" type="text/css" rel="stylesheet">
        <link href="styles/style.css" type="text/css" rel="stylesheet">
        <script src="scripts/jquery-1.10.2.min.js"></script>
        <script src="scripts/bootstrap-3.0.2.min.js"></script>
        <script src="scripts/prettify.js"></script>
        <script src="scripts/jquery.stickytableheaders.min.js"></script>
    		<link href="styles/prettify.css" type="text/css" rel="stylesheet" />
        
        				<script src="scripts/jquery.event.drag.js"></script>
        <script src="scripts/jquery.mousewheel.js"></script>
        <script src="scripts/jquery.svg.js"></script>
        <script src="scripts/jquery.svg.extras.js"></script>
        <script src="scripts/prettify.js"></script>

        <script type="text/javascript" src="scripts/three.js"></script>

        <input type="file" id="files" name="files[]" />
<output id="list"></output>

<script type="text/javascript">
var result;
  function handleFileSelect(evt) {
    var file = evt.target.files[0]; // FileList object
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

    var reader = new FileReader();

      // Closure to capture the file information.
      reader.onload = (function(readFile) {
        return function(e) {
          result = reader.result;
        };
      })(file);

      // Read in the image file as a data URL.
      reader.readAsBinaryString(file);
    }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
        
        <style>
        	body, html {
        	  height: 100%;
        					}
        	
        	.alert-error {
        		font-size: 13px;
        	}
        
        	[class*="span"] {
        		margin-left: 0px;	
        	}
        	
          	#srcArea, #configArea {
        		width: 100%;
        		height: 300px;	
        		font-size: 10px;
        	}
        	
        	#resGraph {
        		width: 100%;
        		height: 100%;
        	}
        	
        	.row {
        	    margin-bottom: 5px;  
        	}
        	
        	svg {
        		width: 100%;
        		height: 100%;
        	}
        
        	textarea {
        		resize: none;
        	}
        	
        	.pre-scrollable {
        		max-height: 500px;
        	}
        	
        	pre.prettyprint {
        		border: 1px solid rgba(0, 0, 0, 0.15);
        	}
        </style>
        <style>
            body {
                padding-top: 70px;
            } 
            pre.prettyprint {
                padding: 9px;
            }
        </style>
        <script type="text/javascript">
          $(function() {
              // remove leading whitespace from each code element 
              $('.prettyprint').each(function() {
               var code = $(this);
               var text = code.html();
               if (text) {
                  var lines = text.split("\n");
                  if (lines.length > 0) {
                      var match = /^\s+(.+)$/.exec(lines[0]);
                      if (match && match.length > 1) {
                        var length = match[0].length - match[1].length;         
                        var strippedLines = $.map(lines, function(e, i) {
                            var woWhitespaces = e.substring(length);
                            return woWhitespaces;
                        });
                      }
                      // replace with the whitespace free code
                      code.html(strippedLines.join("\n"));
                  }
               }
              });
              
              prettyPrint();
          });
        </script>
    </head>
    <body>

        <header class="navbar navbar-inverse navbar-fixed-top">
          <div class="container">
              <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="Index.html">KIELER</a>
              </div>
            <nav class="nav navbar-nav" role="navigation">
              <div class="collapse navbar-collapse" id="navbar-collapse">
                <ul class="nav navbar-nav">
                  <li><a href='Providedlayout.html'>Provided Layout</a></li>
                  <li><a href='Serviceinterface.html'>Service Interface</a></li>
                  <li><a href='Downloads.html'>Downloads</a></li>
                  <li><a href='Contact.html'>Contact</a></li>
                  <li><a href='Live.html'>Live</a></li>
                </ul>
              </div>
            </nav>
          </div>
        </header>
                            
        <div class="container">	
        	<div class="row">
        		<div id="srcGraph" class="col-md-8">
        			<h4>Input Graph <small><a href="Providedlayout.html#formats">See Formats</a></small></h4>
                    <textarea id="srcArea">
                    </textarea>
        		</div>
        		<div id="config" class="col-md-4">
        			<h4>Config <small><a href="Providedlayout.html#algorithms">See Layout Options</a></small></h4>
                    <textarea id="configArea">
                    </textarea>
        		</div>
        	</div>
        	<div class="row">
        	    <div class="col-md-12">
        		<div class="col-md-3 input-group">
        			<span class="input-group-addon">Input Format</span>
        			<select id="inputFormat" class="form-control">
        				<option  value="de.cau.cs.kieler.kgraph">KGraph</option><option  value="gov.nist.math.matrix">Matrix</option><option  value="org.graphviz.dot">Dot</option><option  value="de.uni-passau.fim.gml">GML</option><option  value="org.graphdrawing.graphml">GraphML</option><option selected="selected" value="org.json">JSON</option><option  value="net.ogdf.ogml">OGML</option><option  value="org.w3.svg">SVG</option>
        			</select>
        		</div>
        		<div class=" col-md-3 input-group">
        			<span class="input-group-addon">Output Format</span>
        			<select id="outputFormat" class="form-control">
        				<option  value="de.cau.cs.kieler.kgraph">KGraph</option><option  value="gov.nist.math.matrix">Matrix</option><option  value="org.graphviz.dot">Dot</option><option  value="de.uni-passau.fim.gml">GML</option><option  value="org.graphdrawing.graphml">GraphML</option><option  value="org.json">JSON</option><option  value="net.ogdf.ogml">OGML</option><option selected="selected" value="org.w3.svg">SVG</option>
        			</select>
        		</div>
        		<button id="layout" class="btn pull-right" style="margin-right: 10px">Layout</button><span id="working"></span>
        		</div>
        	</div>
        
        	<div class="row">
        	    <div class="col-md-12">
        		   <div id="errorDiv" class="alert alert-error" style="display: none;"></div>
        		</div>
        	</div>
        </div>	
         
         <!-- the svg gets the remaining size, i.e full display area -->
         <div id="resGrsaph"></div>
         
          <div id="glcontainer"></div>
        <script type="text/javascript">
        var cap;

    $(function() {
      var scene = new THREE.Scene();
      var w = window.innerWidth;  // window.innerWidth / Height
      var h = 600;
      var camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 1000);
      var renderer = new THREE.WebGLRenderer();
      renderer.autoClear = true;
      renderer.setClearColor( 0xEEEEEE, 1 );
      renderer.setSize(w, h);
      var axis = new THREE.AxisHelper(20);

      var loader = new THREE.ObjectLoader();

      
      loader.load(
          // resource URL
          "static/Capacitor.json",
      
          // pass the loaded data to the onLoad function.
      //Here it is assumed to be an object
          function ( obj ) {
          //add the loaded object to the scene
          this.cap = obj;
              //scene.add( obj );
          },
      
          // Function called when download progresses
          function ( xhr ) {
              //console.log( (xhr.loaded / xhr.total * 100) + '% loaded' );
          },
      
          // Function called when download errors
          function ( xhr ) {
              console.error( 'An error happened loading an object!' );
          }
      );

      var planeGeometry = new THREE.PlaneGeometry(10, 10, 1, 1);
      var planeMaterial = new THREE.MeshBasicMaterial({color:0xCCCCCC});
      var plane = new THREE.Mesh(planeGeometry, planeMaterial);
      //plane.rotation.y = -0.5*Math.PI;
      plane.position.x = 0;
      plane.position.y = 0;
      plane.position.z = -10;

      scene.add(plane);


      camera.position.x = 0;
      camera.position.y = 0;
      camera.position.z = 400;
      camera.lookAt(plane.position);
      var istrue = false;
      function render() {
              for(var i = 0; i < scene.children.length; ++i) {
        scene.children[i].rotation.z += 0.01;
      }
      requestAnimationFrame(render)
      renderer.render(scene, camera);


      }

      $("#glcontainer").append(renderer.domElement);
      render();
          
          // add tabbing behavior to the textareas
          $('textarea').keydown(function(e) {
          
           if (e.keyCode === 9) { // tab
             var start = this.selectionStart;
             var end = this.selectionEnd;
             
             // replace textarea content with text before + tabs + text after
             $(this).val($(this).val().substring(0, start)
               + "    " // 4 spaces
               + $(this).val().substring(end));
               
             // move cursor 
             this.selectionStart = this.selectionEnd = start + 4;
             
             // prevent the default tab behavior
             e.preventDefault();
           }
          });
        
        	$('#layout').click(function() {
            if(result === undefined) {
              alert("no json component chosen!");
              return;
            }

            var worker = new Worker('klayjs.js');
                      
            var config = '{' + $('#configArea').val() + '}';

            worker.addEventListener('message', function (e) {
            var graph = e.data;
            //console.log(graph);

            var comps = graph.children;
            var edges = graph.edges;

            for(var i = 0; i < comps.length; ++i) {
              var planeGeometry = new THREE.PlaneGeometry(comps[i].width, comps[i].height, 1, 1);
              var planeMaterial = new THREE.MeshBasicMaterial({color:0xff0000});
              var plane = new THREE.Mesh(planeGeometry, planeMaterial);
              //plane.rotation.y = -0.5*Math.PI;
              var x = comps[i].x + comps[i].width/2;
              var y = comps[i].y + comps[i].height/2;
              plane.position.x = x;
              plane.position.y = y;
              plane.position.z = -5;


              console.log(cap);
              var obj = cap.clone();
              obj.position.x = x;
              obj.position.y = y;
              obj.position.z = -5;
              obj.scale.x = obj.scale.y = obj.scale.z = 20;
        
              scene.add(obj);
            }

              for(var i = 0; i < edges.length; ++i) {
              var planeGeometry = new THREE.PlaneGeometry(7, 7, 1, 1);
              var planeMaterial = new THREE.MeshBasicMaterial({color:0xffff1a});
              var plane = new THREE.Mesh(planeGeometry, planeMaterial);
              //plane.rotation.y = -0.5*Math.PI;
              var x = edges[i].sourcePoint.x;
              var y = edges[i].sourcePoint.y;
              plane.position.x = x;
              plane.position.y = y;
              plane.position.z = -3;
        
              scene.add(plane);
                            var planeGeometry = new THREE.PlaneGeometry(7, 7, 1, 1);
              var planeMaterial = new THREE.MeshBasicMaterial({color:0xffff1a});
              var plane = new THREE.Mesh(planeGeometry, planeMaterial);
              var x = edges[i].targetPoint.x;
              var y = edges[i].targetPoint.y;
              plane.position.x = x;
              plane.position.y = y;
              plane.position.z = -3;
        
              scene.add(plane);

              var bendPoints = edges[i].bendPoints;
              if(bendPoints !== undefined)
              for(var j = 0; j < edges[i].bendPoints.length; ++j) {
              var planeGeometry = new THREE.PlaneGeometry(2, 2, 1, 1);
              var planeMaterial = new THREE.MeshBasicMaterial({color:0x33cc33});
              var plane = new THREE.Mesh(planeGeometry, planeMaterial);
              //plane.rotation.y = -0.5*Math.PI;
              var x = edges[i].bendPoints[j].x;
              var y = edges[i].bendPoints[j].y;
              plane.position.x = x;
              plane.position.y = y;
              plane.position.z = -5;
        
              scene.add(plane);
              }

            }
            });

            var graph = JSON.parse(result);

            worker.postMessage({
              graph: graph,
              options: config
        	});
            });
        	
        	var exConfig = "spacing: 0,\nalgorithm: de.cau.cs.kieler.klay.layered,\nedgeRouting: ORTHOGONAL";
        	$('#configArea').val(exConfig);
        });
        </script>
        
        <script type="text/javascript">
            var offset = $('.navbar').height();
            $("html:not(.legacy) table").stickyTableHeaders({fixedOffset: offset});
        </script>
    </body>
</html>
